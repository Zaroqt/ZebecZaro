<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZZ Feed (Community Posts)</title>
    
    <!-- External Dependencies -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        /*
         * ZZ Feed - Custom CSS (Merged from tma-style.css)
         */

        /* -------------------------------------- */
        /* 1. Global & Variables */
        /* -------------------------------------- */
        :root {
            --tg-theme-bg-color: #0d1117; 
            --tg-theme-secondary-bg-color: #1a202c;
            --tg-theme-text-color: #ffffff;
            --tg-theme-link-color: #20b2aa; 
            --tg-theme-button-color: #4caf50; 
            --tg-theme-button-text-color: #ffffff;
            --tg-theme-destructive-text-color: #ff9800; 
            --tg-theme-hint-color: #bdbdbd; 
            --border-radius-main: 12px;
            --spacing-unit: 16px;
            --fab-size: 56px;
            --nav-height: 60px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* -------------------------------------- */
        /* 2. Header & Navigation */
        /* -------------------------------------- */
        .fixed-header-area {
            position: sticky;
            top: 0;
            z-index: 10; 
            background-color: var(--tg-theme-bg-color);
            padding-bottom: 5px; 
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-unit);
            padding-bottom: 0;
        }

        .music-info-area {
            display: flex;
            align-items: center;
            background-color: var(--tg-theme-secondary-bg-color);
            border-radius: var(--border-radius-main);
            padding: 8px 12px;
            font-size: 0.9rem;
            cursor: pointer; 
        }

        #volume-toggle {
            font-size: 1.1rem;
            color: var(--tg-theme-link-color);
            padding: 0;
            margin-left: 5px;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--tg-theme-link-color);
            cursor: pointer;
            padding: 8px;
            font-size: 1.2rem;
            border-radius: 50%;
            transition: background-color 0.2s;
        }

        .filter-tabs {
            display: flex;
            justify-content: space-around;
            padding: 0 var(--spacing-unit);
            margin-top: 10px;
            gap: 8px;
        }

        .filter-tab {
            flex-grow: 1;
            background-color: var(--tg-theme-secondary-bg-color);
            color: var(--tg-theme-hint-color);
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            white-space: nowrap;
        }

        .filter-tab.active {
            background-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
            box-shadow: 0 2px 5px rgba(32, 178, 170, 0.5);
        }

        .bottom-nav {
            display: flex;
            justify-content: space-around;
            background-color: var(--tg-theme-secondary-bg-color);
            height: var(--nav-height);
            box-shadow: 0 -4px 8px rgba(0, 0, 0, 0.2);
            z-index: 15; 
        }

        .nav-item {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 5px 0;
            background: none;
            border: none;
            color: var(--tg-theme-hint-color);
            cursor: pointer;
            transition: color 0.2s;
        }

        .nav-item i {
            font-size: 1.3rem;
        }

        .nav-item span {
            font-size: 0.7rem;
            margin-top: 2px;
        }

        .nav-item.active {
            color: var(--tg-theme-link-color);
        }


        /* -------------------------------------- */
        /* 3. Content & Screens */
        /* -------------------------------------- */
        .content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px var(--spacing-unit); 
            padding-bottom: calc(var(--nav-height) + 20px); 
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .posts-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
        }

        .post-card {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius-main);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .post-card .admin-badge {
            display: inline-block;
            background-color: var(--tg-theme-link-color); 
            color: var(--tg-theme-button-text-color);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .post-content {
            font-size: 1.1rem;
            line-height: 1.5;
            margin-bottom: 12px;
            white-space: pre-wrap; 
        }

        .post-actions {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 15px;
        }

        .like-btn, .delete-btn {
            background: none;
            border: 1px solid var(--tg-theme-hint-color);
            color: var(--tg-theme-hint-color);
            padding: 6px 12px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .like-btn.liked {
            background-color: var(--tg-theme-link-color);
            border-color: var(--tg-theme-link-color);
            color: var(--tg-theme-button-text-color);
        }

        .delete-btn {
            border-color: var(--tg-theme-destructive-text-color);
            color: var(--tg-theme-destructive-text-color);
        }

        .profile-card {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius-main);
            text-align: center;
            margin-top: 40px;
        }

        .avatar-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #555;
            margin: -40px auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            overflow: hidden;
            box-shadow: 0 0 0 4px var(--tg-theme-bg-color), 0 0 0 5px var(--tg-theme-secondary-bg-color);
        }

        .profile-card h2 {
            margin-bottom: 5px;
            color: var(--tg-theme-text-color);
        }

        .hint-text {
            color: var(--tg-theme-hint-color);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--tg-theme-bg-color);
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .copy-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        #telegram-chat-id {
            font-family: monospace;
            color: var(--tg-theme-link-color);
        }

        .close-app-btn {
            width: 100%;
            padding: 10px;
            background-color: var(--tg-theme-destructive-text-color);
            color: var(--tg-theme-button-text-color);
            border: none;
            border-radius: 8px;
            margin-top: 20px;
            cursor: pointer;
            font-weight: bold;
        }


        /* -------------------------------------- */
        /* 5. FAB (Admin Post Button) */
        /* -------------------------------------- */
        .fab {
            position: fixed;
            bottom: calc(var(--nav-height) + 15px);
            right: 20px;
            width: var(--fab-size);
            height: var(--fab-size);
            border-radius: 50%;
            background-color: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            z-index: 20; 
            transition: transform 0.3s;
        }

        .fab:active {
            transform: scale(0.95);
        }

        /* -------------------------------------- */
        /* 6. Modals & Toast (CRITICAL FINAL FIX) */
        /* -------------------------------------- */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            
            /* 🚨 CRITICAL FIX: Default အားဖြင့် လုံးဝ ပိတ်ထားမည် */
            pointer-events: none; 
            visibility: hidden; 
            opacity: 0; 
            
            display: flex; 
            justify-content: center;
            align-items: center;
            z-index: 1000; 
            
            /* ဖွင့်/ပိတ် Transition: 0.3s ညှိလိုက်သည် */
            transition: opacity 0.3s ease-out, visibility 0.3s; 
        }

        .modal-overlay.active {
            pointer-events: auto; /* Modal ဖွင့်ရင် Clickable ဖြစ်စေရန် */
            visibility: visible; 
            opacity: 1;
        }

        .modal-content {
            background-color: var(--tg-theme-secondary-bg-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius-main);
            width: 90%;
            max-width: 400px;
            transform: translateY(20px);
            opacity: 0;
            /* content ရဲ့ animation ကိုလည်း 0.3s ညှိလိုက်သည် */
            transition: transform 0.3s ease-out, opacity 0.3s ease-out; 
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
            opacity: 1;
        }

        /* Modal Content Styles (unchanged) */

        .modal-content h3 {
            margin-bottom: 15px;
            color: var(--tg-theme-link-color);
        }

        textarea, input[type="url"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background-color: var(--tg-theme-bg-color);
            color: var(--tg-theme-text-color);
            resize: vertical;
            font-size: 1rem;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions .full-width {
            width: 100%;
            justify-content: center;
        }

        .modal-cancel-btn, .modal-submit-btn {
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            border: none;
            transition: opacity 0.2s;
        }

        .modal-cancel-btn {
            background: none;
            color: var(--tg-theme-hint-color);
        }

        .modal-submit-btn {
            background-color: var(--tg-theme-button-color); 
            color: var(--tg-theme-button-text-color);
        }

        .music-option-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }

        .music-option {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: var(--tg-theme-bg-color);
            border-radius: 8px;
            color: var(--tg-theme-text-color);
            cursor: pointer;
            transition: background-color 0.2s;
            border: 1px solid var(--tg-theme-bg-color);
        }

        .music-option:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .music-option i {
            margin-right: 10px;
            color: var(--tg-theme-link-color);
        }

        /* Toast Notification z-index */
        .custom-toast {
            visibility: hidden;
            min-width: 250px;
            background-color: rgba(0, 0, 0, 0.85);
            color: #fff;
            text-align: center;
            border-radius: var(--border-radius-main);
            padding: 12px;
            position: fixed;
            z-index: 1001; 
            left: 50%;
            transform: translateX(-50%);
            bottom: 80px; 
            font-size: 0.9rem;
            transition: opacity 0.3s, bottom 0.3s;
            opacity: 0;
        }

        .custom-toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 100px;
        }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div class="fixed-header-area">
            <header>
                <div class="music-info-area">
                    <span id="current-music-status">Music Paused (Tap Icon to Play)</span>
                    <i id="volume-toggle" class="fas fa-volume-off" title="Start Playing Music"></i>
                </div>
                <button id="music-button" class="icon-btn" aria-label="Music Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </header>
            
            <div class="filter-tabs" role="tablist">
                <button id="new-posts-tab" class="filter-tab active" data-filter="new-posts" role="tab" aria-selected="true">
                    🔥 New Posts
                </button>
                <button class="filter-tab" data-filter="old-posts" role="tab" aria-selected="false">
                    ⏳ Oldest
                </button>
            </div>
        </div>

        <div class="content">
            
            <div id="home-screen" class="screen active">
                <div id="posts-container" class="posts-list">
                    <p class="initial-loading-text">Loading posts...</p>
                </div>
            </div>

            <div id="profile-screen" class="screen">
                <div class="profile-card">
                    <div id="profile-avatar-placeholder" class="avatar-placeholder">U</div>
                    <h2 id="profile-display-name">Loading...</h2>
                    <p id="profile-display-username" class="hint-text">Username N/A</p>
                    <span id="admin-status" class="admin-badge">Regular User</span>

                    <div class="info-row">
                        <span>Telegram Chat ID:</span>
                        <div class="copy-area">
                            <span id="telegram-chat-id">0</span>
                            <button id="chat-id-copy-btn" class="icon-btn" aria-label="Copy User ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <button id="tma-close-btn" class="close-app-btn">
                        <i class="fas fa-times-circle"></i> Close Mini App
                    </button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="home-screen" aria-label="Home Feed">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-screen="profile-screen" aria-label="Profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </nav>
        
        <button id="post-add-button" class="fab" aria-label="Add New Post" style="display:none;">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modals -->
    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Create New Post</h3>
            <textarea id="post-input" placeholder="Type your announcement (5-500 chars)" maxlength="500"></textarea>
            <div class="modal-actions">
                <button id="cancel-post-btn" class="modal-cancel-btn">Cancel</button>
                <button id="submit-post-btn" class="modal-submit-btn">Post Now</button>
            </div>
        </div>
    </div>

    <div id="music-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Music Settings</h3>
            <p class="hint-text">Choose your background audio source.</p>
            <div class="music-option-list">
                <button class="music-option" data-music-type="default">
                    <i class="fas fa-headphones"></i> Use Default Lofi
                </button>
                <button class="music-option" data-music-type="url">
                    <i class="fas fa-link"></i> Use Custom URL
                </button>
                <label for="music-upload-input" class="music-option">
                    <i class="fas fa-upload"></i> Upload Local File (.mp3)
                </label>
                <input type="file" id="music-upload-input" accept="audio/mp3,audio/*" style="display: none;">
            </div>
            <div class="modal-actions">
                <button id="cancel-music-modal-btn" class="modal-cancel-btn full-width">Close</button>
            </div>
        </div>
    </div>
    
    <div id="url-input-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Custom Music URL</h3>
            <input type="url" id="music-url-input" placeholder="Enter HTTP/HTTPS audio link">
            <div class="modal-actions">
                <button id="close-url-modal-btn" class="modal-cancel-btn">Back</button>
                <button id="play-url-btn" class="modal-submit-btn">Set & Play</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <div id="custom-toast" class="custom-toast"></div>

    <!-- Firebase Initialization and Application Script (Merged from tma-script.js and index.html module) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, doc, getDoc, getDocs, where, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables from Canvas Environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth;

        // ********** SET YOUR ADMIN CHAT ID(s) HERE **********
        // IDs should be integers as returned by Telegram
        const ADMIN_CHAT_IDS = [ 
            1924452453, // Replace with your actual ID
            6440295843, 
            6513916873, 
            // Add additional Admin IDs here:
        ]; 
        // *************************************************

        // --- Global Variables & Constants ---
        const POSTS_COLLECTION = 'tma_zzfeed_posts'; // Canvas Public Path: /artifacts/{appId}/public/data/tma_zzfeed_posts
        const LIKES_COLLECTION = 'tma_zzfeed_likes'; // Canvas Public Path: /artifacts/{appId}/public/data/tma_zzfeed_likes
        const TEMP_MUSIC_KEY = 'tma_temp_music_url_v5';
        const INITIAL_DEFAULT_URL = 'https://archive.org/download/lofi-chill-1-20/lofi_chill_03_-_sleepwalker.mp3'; 

        let audioPlayer;
        let musicStatusSpan;
        let volumeToggleIcon;
        let currentUserId = 0; 
        let currentUserName = 'Guest';
        let currentUserUsername = 'anonymous'; 
        let is_admin = false; 
        let currentPostFilter = 'new-posts'; 
        let isMusicMuted = false; 
        let tg = null;
        let unsubscribeFromPosts = null; 
        let isAuthReady = false;

        // ===========================================
        //          FIREBASE & AUTH SETUP
        // ===========================================
        async function setupFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                document.getElementById('posts-container').innerHTML = '<p class="initial-loading-text" style="color:red;">❌ Firebase Configuration is missing.</p>';
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); 
                
                // 1. Sign in or authenticate using the custom token
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken).catch(error => {
                        console.error("Custom token sign-in failed:", error);
                        return signInAnonymously(auth);
                    });
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up Auth State Listener and trigger main app logic
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        isAuthReady = true;
                        // Once authenticated, start the TMA application
                        setupTMA();
                    } else {
                        // This case handles initial anonymous sign-in failure or sign-out
                        console.error("Authentication failed. Running in limited mode.");
                        isAuthReady = true;
                        setupTMA(); // Still try to run the TMA setup for mock/fallback
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('posts-container').innerHTML = '<p class="initial-loading-text" style="color:red;">❌ Firebase initialization failed. Check console for details.</p>';
            }
        }
        
        // ===========================================
        //          HELPER FUNCTIONS (tma-script.js)
        // ===========================================
        function showToast(message) { 
            const toast = document.getElementById('custom-toast');
            if (!toast) return;
            clearTimeout(toast.timeoutId);
            toast.textContent = message;
            toast.classList.add('show');
            toast.timeoutId = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
            if (tg && tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        }

        function isAdminUser(userId) {
            return ADMIN_CHAT_IDS.includes(parseInt(userId));
        }

        function stringToColor(str) { 
            let hash = 0; for (let i = 0; i < str.length; i++) { hash = str.charCodeAt(i) + ((hash << 5) - hash); }
            let color = '#';
            for (let i = 0; i < 3; i++) {
                const value = (hash >> (i * 8)) & 0xFF;
                const brightened = Math.floor(value * 0.7 + 0x55); 
                color += ('00' + brightened.toString(16)).substr(-2);
            }
            return color;
        }

        function copyToClipboard(text, successMsg = 'Copied successfully.') { 
            // Use document.execCommand('copy') for better iframe compatibility
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            tempInput.style.position = 'absolute';
            tempInput.style.left = '-9999px';
            document.body.appendChild(tempInput);
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); 
            try {
                document.execCommand('copy');
                showToast(successMsg);
            } catch (err) {
                showToast('Copy failed, please select and copy manually.');
                console.error("Copy failed:", err);
            }
            document.body.removeChild(tempInput);
        }

        // ===========================================
        //          DATA/STORAGE HANDLERS
        // ===========================================

        // Helper to get the correct public collection reference
        function getPublicCollectionRef(collectionName) {
            if (!db || !appId) {
                console.error("Database or App ID not available.");
                return null;
            }
            // MANDATORY Canvas Public Path: /artifacts/{appId}/public/data/{collectionName}
            return collection(db, `artifacts/${appId}/public/data/${collectionName}`);
        }

        function loadPostsRealtime(userId) { 
            if (!db || !isAuthReady) {
                const container = document.getElementById('posts-container');
                if(container) container.innerHTML = '<p class="initial-loading-text" style="color:var(--tg-theme-destructive-text-color);">❌ Database Not Initialized/Authenticated.</p>';
                return;
            }
            if (unsubscribeFromPosts) { unsubscribeFromPosts(); }
            const container = document.getElementById('posts-container');
            if (!container) return;
            container.innerHTML = '<p class="initial-loading-text">Connecting to server...</p>';

            const postsColRef = getPublicCollectionRef(POSTS_COLLECTION);
            if (!postsColRef) return;

            const sortField = 'timestamp';
            const sortDirection = currentPostFilter === 'new-posts' ? 'desc' : 'asc';
            
            // Create query using modular functions
            const postsQuery = query(postsColRef, orderBy(sortField, sortDirection));

            unsubscribeFromPosts = onSnapshot(postsQuery, async (snapshot) => {
                const posts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                container.innerHTML = ''; 
                
                if (posts.length === 0) {
                    container.innerHTML = '<p class="initial-loading-text">No posts found yet. Be the first to post!</p>';
                } else {
                    const postElements = await Promise.all(posts.map(post => createPostElement(post, userId)));
                    postElements.forEach(el => container.appendChild(el));
                }
                addPostEventListeners(userId); 
            }, error => {
                console.error("Error listening to posts:", error);
                container.innerHTML = '<p class="initial-loading-text" style="color:var(--tg-theme-destructive-text-color);">❌ Failed to load posts. Check Security Rules/Network.</p>';
                showToast("Error connecting to database.");
            });
        }

        async function toggleLike(e, userId) { 
            if (!db || !isAuthReady) { showToast("Database not ready."); return; }
            const likeButton = e.currentTarget;
            const postId = likeButton.getAttribute('data-post-id');
            
            // Like document reference using modular doc function
            const likeDocRef = doc(db, `artifacts/${appId}/public/data/${LIKES_COLLECTION}`, `${postId}_${userId}`);
            
            try {
                const d = await getDoc(likeDocRef);
                let change = 0;
                let isLikedNow = false;

                if (d.exists()) {
                    await deleteDoc(likeDocRef);
                    change = -1;
                    isLikedNow = false;
                    showToast("Unliked.");
                } else {
                    // Using setDoc here for explicit ID
                    await setDoc(likeDocRef, { 
                        postId: postId, 
                        userId: userId, 
                        timestamp: serverTimestamp() 
                    });
                    change = 1;
                    isLikedNow = true;
                    showToast("Liked!");
                }
                updateLikeCountDisplay(likeButton, change, isLikedNow);
            } catch (error) {
                console.error("Error toggling like:", error);
                showToast("Action failed. Try again. (Check Security Rules)");
            }
        }

        function updateLikeCountDisplay(likeButton, change, isLikedNow) {
            // This function is kept for optimistic UI update, but the next snapshot update will override it
            const currentCountText = likeButton.textContent.replace(/[^0-9]/g, ''); 
            let currentCount = parseInt(currentCountText) || 0;
            const newCount = Math.max(0, currentCount + change);
            likeButton.innerHTML = `<i class="fas fa-heart"></i> ${newCount}`;
            likeButton.classList.toggle('liked', isLikedNow);
        }

        async function getPostLikeCount(postId) {
            if (!db || !isAuthReady) return 0;
            try {
                const likesColRef = getPublicCollectionRef(LIKES_COLLECTION);
                // NOTE: Using 'where' requires an index, which is standard practice for this use case.
                const snapshot = await getDocs(query(likesColRef, where('postId', '==', postId)));
                return snapshot.size;
            } catch (error) {
                console.error("Error fetching like count for post (Check Firebase Indexes):", postId, error);
                return 0;
            }
        }


        async function createPostElement(post, userId) { 
            const postId = post.id;
            const postElement = document.createElement('div');
            postElement.className = 'post-card';
            postElement.setAttribute('data-post-id', postId);
            
            // Check like status only if DB is ready
            let isLiked = false;
            let displayLikesCount = 0;
            if (db && isAuthReady) {
                const likeDoc = await getDoc(doc(db, `artifacts/${appId}/public/data/${LIKES_COLLECTION}`, `${postId}_${userId.toString()}`));
                isLiked = likeDoc.exists();
                displayLikesCount = await getPostLikeCount(postId);
            }

            const isAdmin = isAdminUser(userId);
            const deleteButton = isAdmin 
                ? `<button class="delete-btn" data-post-id="${postId}"><i class="fas fa-trash"></i> Delete</button>` 
                : '';
            const adminBadge = post.isAdmin ? '<span class="admin-badge">Admin</span>' : '';

            postElement.innerHTML = `
                ${adminBadge}
                <p class="post-content">${post.content}</p>
                <div class="post-actions">
                    <button class="like-btn ${isLiked ? 'liked' : ''}" data-post-id="${postId}" aria-label="${isLiked ? 'Unlike' : 'Like'} Post">
                        <i class="fas fa-heart"></i> 
                        ${displayLikesCount}
                    </button>
                    ${deleteButton} 
                </div>
            `;
            return postElement;
        } 

        function performDeletePost(postId, userId) { 
            if (!isAdminUser(userId) || !db || !isAuthReady) {
                showToast("Only Admins can delete posts or database not ready.");
                return;
            }
            // Modular doc reference and deleteDoc
            const postRef = doc(db, `artifacts/${appId}/public/data/${POSTS_COLLECTION}`, postId);
            deleteDoc(postRef).then(() => {
                showToast("Post deleted successfully!");
            }).catch(error => {
                console.error("Error removing document: ", error);
                showToast("Deletion failed on server. (Check Security Rules)");
            });
        }

        function addPostEventListeners(userId) { 
            document.querySelectorAll('.like-btn').forEach(button => {
                button.onclick = (e) => toggleLike(e, userId); 
            });
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.onclick = (e) => {
                    const postId = e.currentTarget.getAttribute('data-post-id');
                    // Use Telegram's native confirmation dialog if available
                    if (tg && tg.showConfirm) {
                        tg.showConfirm('Are you sure you want to delete this post?', (ok) => {
                            if (ok) performDeletePost(postId, userId);
                        });
                    } else {
                        // Fallback to a warning toast
                        showToast("Deletion requires Admin confirmation (TMA feature not available).");
                        // For local testing, we'll allow it with a single click after the warning
                        performDeletePost(postId, userId); 
                    }
                };
            });
        }

        function setupPostFilters() { 
            const tabs = document.querySelectorAll('.filter-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const filter = tab.getAttribute('data-filter');
                    tabs.forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    
                    if (currentPostFilter !== filter) {
                        currentPostFilter = filter;
                        const contentArea = document.querySelector('.content');
                        if (contentArea) contentArea.scrollTop = 0; 
                        loadPostsRealtime(currentUserId); 
                    }
                });
            });
        }


        // ===========================================
        //          ADMIN POST LOGIC 
        // ===========================================

        function setupAdminPostLogic(isAdmin) { 
            const postAddButton = document.getElementById('post-add-button');
            const submitPostBtn = document.getElementById('submit-post-btn');
            const cancelPostBtn = document.getElementById('cancel-post-btn');
            const postInput = document.getElementById('post-input');

            if (isAdmin) {
                if (postAddButton) postAddButton.style.display = 'flex';
                if (postAddButton) postAddButton.onclick = () => openModal('post-modal');
                if (cancelPostBtn) { 
                    cancelPostBtn.onclick = () => {
                        postInput.value = ''; 
                        closeModal('post-modal');
                    };
                }

                if (submitPostBtn && postInput) {
                    submitPostBtn.onclick = () => {
                        if (!db || !isAuthReady || !auth.currentUser) {
                            showToast("Error: Database not ready or unauthorized.");
                            closeModal('post-modal');
                            return;
                        }
                        if (!isAdminUser(currentUserId)) {
                            showToast("Error: Authorization failed. You are not recognized as Admin.");
                            closeModal('post-modal');
                            return;
                        }
                        
                        const content = postInput.value.trim();
                        
                        if (content.length < 5 || content.length > 500) {
                            showToast("Post must be between 5 and 500 characters.");
                            return;
                        }
                        
                        submitPostBtn.disabled = true;
                        submitPostBtn.textContent = 'Posting...';

                        // Use modular addDoc and serverTimestamp with correct public collection path
                        const postsColRef = getPublicCollectionRef(POSTS_COLLECTION);
                        if (!postsColRef) {
                            showToast("Posting failed: Invalid collection reference.");
                            submitPostBtn.disabled = false;
                            submitPostBtn.textContent = 'Post Now';
                            return;
                        }

                        const newPost = {
                            authorId: currentUserId.toString(),
                            authorName: currentUserName || 'Admin', 
                            isAdmin: true,
                            content: content,
                            timestamp: serverTimestamp(), // Modular function reference
                        };
                        
                        addDoc(postsColRef, newPost) // Use modular addDoc
                            .then(() => {
                                postInput.value = ''; 
                                
                                const newPostsTab = document.getElementById('new-posts-tab');
                                if (newPostsTab) {
                                newPostsTab.click(); 
                                }
                                
                                closeModal('post-modal'); 
                                showToast("Announcement posted successfully!");
                            })
                            .catch(error => {
                                console.error("Error writing document (Check Security Rules): ", error);
                                showToast(`Posting Failed! (Check Security Rules): ${error.message}`);
                            })
                            .finally(() => {
                                submitPostBtn.disabled = false;
                                submitPostBtn.textContent = 'Post Now';
                            });
                    };
                }
            } else {
                if (postAddButton) postAddButton.style.display = 'none';
                if (postAddButton) postAddButton.onclick = null;
            }
        }


        // ===========================================
        //          MODAL & MUSIC LOGIC 
        // ===========================================

        function openModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            document.body.style.overflow = 'hidden'; 
            modal.classList.add('active');

            const fab = document.getElementById('post-add-button');
            if (fab) fab.style.display = 'none'; 
            
            modal.onclick = (e) => {
                if (e.target === modal) { 
                    closeModal(modalId);
                }
            };
        }

        function closeModal(modalId) { 
            const modal = document.getElementById(modalId);
            if (!modal) return;
            
            modal.classList.remove('active');
            modal.onclick = null; 

            setTimeout(() => {
                if (!document.querySelector('.modal-overlay.active')) {
                        document.body.style.overflow = '';
                }
            
                const homeScreen = document.getElementById('home-screen');
                if (homeScreen && homeScreen.classList.contains('active') && is_admin) {
                    const fab = document.getElementById('post-add-button');
                    if (fab) fab.style.display = 'flex'; 
                }
            }, 300); 
        }

        function updateMusicStatus(isPlaying) { 
            if (!musicStatusSpan || !volumeToggleIcon) return;
            let statusText = isPlaying 
                ? `🎶 Music Playing ${isMusicMuted ? '(Muted)' : ''} 🎶` 
                : 'Music Paused (Tap Icon to Play)';
            musicStatusSpan.textContent = statusText;
            
            if (isPlaying) {
                volumeToggleIcon.className = `fas ${isMusicMuted ? 'fa-volume-off' : 'fa-volume-up'}`;
                volumeToggleIcon.title = isMusicMuted ? "Unmute Music" : "Mute Music";
            } else {
                volumeToggleIcon.className = 'fas fa-volume-off';
                volumeToggleIcon.title = "Start Playing Music";
            }
        }

        function toggleVolume() { 
            if (!audioPlayer) return;

            if (audioPlayer.paused) {
                audioPlayer.volume = isMusicMuted ? 0 : 1;
                
                const playPromise = audioPlayer.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        showToast(isMusicMuted ? "Music started (Muted)." : "Music started playing.");
                    }).catch(e => {
                        console.error("Failed to play audio on click:", e);
                        showToast('Playback Failed. Please tap the volume icon again to allow play.');
                        updateMusicStatus(false);
                    });
                }
            } else {
                isMusicMuted = !isMusicMuted;
                audioPlayer.volume = isMusicMuted ? 0 : 1;
                showToast(isMusicMuted ? "Music muted." : "Music unmuted.");
                updateMusicStatus(true);
            }
        }

        function setupMusicPlayer() { 
            audioPlayer = document.getElementById('audio-player');
            musicStatusSpan = document.getElementById('current-music-status');
            volumeToggleIcon = document.getElementById('volume-toggle');
            
            if (!audioPlayer) return;
            let initialUrl = localStorage.getItem(TEMP_MUSIC_KEY) || INITIAL_DEFAULT_URL;
            audioPlayer.src = initialUrl;
            audioPlayer.loop = true;
            audioPlayer.volume = isMusicMuted ? 0 : 1;
            
            if(volumeToggleIcon) volumeToggleIcon.onclick = toggleVolume;
            
            audioPlayer.onplay = () => updateMusicStatus(true);
            audioPlayer.onpause = () => updateMusicStatus(false);
            
            audioPlayer.onerror = (e) => { 
                console.error("Audio error details:", e);
                audioPlayer.pause();
                updateMusicStatus(false);
                showToast("Music Load Error. Playing stopped. Check URL or file."); 
            };
            
            updateMusicStatus(false); 
        }

        function setMusicUrl(url, sourceName) { 
            if (!url || !audioPlayer) return;
            
            if (!url.match(/^https?:\/\/.+\..+$/) && url !== INITIAL_DEFAULT_URL && !url.startsWith('blob:')) {
                showToast("Invalid URL format. http/https required.");
                return;
            }
            
            localStorage.setItem(TEMP_MUSIC_KEY, url);
            audioPlayer.src = url;
            audioPlayer.load();
            audioPlayer.pause(); 
            
            closeModal('music-modal');
            closeModal('url-input-modal');
            showToast(`${sourceName} set. Tap the Volume Icon to play.`);
        }

        function addMusicEventListeners() { 
            document.getElementById('music-button').onclick = () => openModal('music-modal');
            document.getElementById('cancel-music-modal-btn').onclick = () => closeModal('music-modal');
            
            document.querySelectorAll('.music-option-list .music-option').forEach(option => {
                option.onclick = (e) => {
                    const type = e.currentTarget.getAttribute('data-music-type');
                    if (type === 'default') {
                        setMusicUrl(INITIAL_DEFAULT_URL, "Default Track"); 
                    } else if (type === 'url') {
                        closeModal('music-modal'); 
                        openModal('url-input-modal'); 
                        const urlInput = document.getElementById('music-url-input');
                        const savedUrl = localStorage.getItem(TEMP_MUSIC_KEY);
                        if (urlInput) urlInput.value = (savedUrl && savedUrl !== INITIAL_DEFAULT_URL) ? savedUrl : ''; 
                    }
                };
            });

            document.getElementById('close-url-modal-btn').onclick = () => {
                closeModal('url-input-modal');
                openModal('music-modal'); 
            };
            
            document.getElementById('play-url-btn').onclick = () => {
                const url = document.getElementById('music-url-input').value.trim();
                if (url) {
                    setMusicUrl(url, "Custom URL"); 
                } else {
                    showToast("Please enter a valid Music URL.");
                }
            };
            
            const fileInput = document.getElementById('music-upload-input');
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file && file.type.startsWith('audio/')) {
                    const url = URL.createObjectURL(file); 
                    setMusicUrl(url, file.name); 
                } else {
                        showToast("Please select a valid audio file.");
                }
                e.target.value = null; 
            };
        }


        // ===========================================
        //          MAIN ENTRY
        // ===========================================

        function updateProfileDisplay(userId, fullName, username, is_admin) { 
            const displayUsername = username ? `@${username}` : 'Username N/A';
            document.getElementById('profile-display-name').textContent = fullName || 'User';
            document.getElementById('profile-display-username').textContent = displayUsername;
            document.getElementById('telegram-chat-id').textContent = userId.toString();
            const adminStatusEl = document.getElementById('admin-status');
            adminStatusEl.textContent = is_admin ? 'Administrator' : 'Regular User';
            adminStatusEl.style.backgroundColor = is_admin ? 'var(--tg-theme-link-color)' : 'var(--tg-theme-hint-color)';
            
            const tgUser = tg ? tg.initDataUnsafe.user : null;
            const tgPhotoUrl = tgUser ? tgUser.photo_url : null;
            const profileAvatarPlaceholder = document.getElementById('profile-avatar-placeholder');

            if (profileAvatarPlaceholder) {
                if (tgPhotoUrl) {
                    profileAvatarPlaceholder.innerHTML = `<img src="${tgPhotoUrl}" alt="${fullName || 'Profile Photo'}" style="width:100%; height:100%; object-fit:cover; border-radius:50%;">`;
                    profileAvatarPlaceholder.style.backgroundColor = 'transparent';
                    profileAvatarPlaceholder.textContent = '';
                } else {
                    const userColor = stringToColor(userId.toString());
                    const initial = (fullName.charAt(0) || 'U').toUpperCase();
                    profileAvatarPlaceholder.innerHTML = ''; 
                    profileAvatarPlaceholder.style.backgroundColor = userColor;
                    profileAvatarPlaceholder.textContent = initial;
                    profileAvatarPlaceholder.style.fontSize = '1.5rem';
                }
            }
        }

        function setupProfileListeners() { 
            const copyBtn = document.getElementById('chat-id-copy-btn');
            if (copyBtn) copyBtn.onclick = () => copyToClipboard(currentUserId.toString(), 'User ID copied.');
            const closeBtn = document.getElementById('tma-close-btn');
            if (closeBtn) closeBtn.onclick = () => tg && tg.close ? tg.close() : showToast("Mini App Close API Not Available."); 
        }

        function switchScreen(targetScreenId) { 
            document.querySelectorAll('.content .screen').forEach(screen => screen.classList.remove('active'));
            const targetScreen = document.getElementById(targetScreenId);
            if (targetScreen) targetScreen.classList.add('active');
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.classList.toggle('active', item.getAttribute('data-screen') === targetScreenId);
            });
            
            const fixedHeaderArea = document.querySelector('.fixed-header-area');
            const fab = document.getElementById('post-add-button');
            const contentArea = document.querySelector('.content');
            const headerHeight = fixedHeaderArea ? fixedHeaderArea.offsetHeight : 0;
            
            if (targetScreenId === 'profile-screen') {
                if (fixedHeaderArea) fixedHeaderArea.style.display = 'none';
                if (contentArea) contentArea.style.paddingTop = '20px'; 
                if (fab) fab.style.display = 'none';
            } else { // home-screen
                if (fixedHeaderArea) fixedHeaderArea.style.display = 'block';
                if (contentArea) contentArea.style.paddingTop = `${headerHeight + 20}px`; 
                if (fab && is_admin) fab.style.display = 'flex'; 
            }
            if (contentArea) contentArea.scrollTop = 0;
        }

        function addNavigationListeners() { 
            document.querySelectorAll('.bottom-nav .nav-item').forEach(item => {
                item.addEventListener('click', (e) => switchScreen(e.currentTarget.getAttribute('data-screen')));
            });
        }

        function main() { 
            const user = tg.initDataUnsafe.user;
            if (user && user.id) {
                currentUserId = parseInt(user.id);
                const nameParts = [user.first_name, user.last_name].filter(Boolean);
                currentUserName = nameParts.length > 0 ? nameParts.join(' ') : 'Anonymous User';
                currentUserUsername = user.username || null;
                is_admin = isAdminUser(currentUserId);
            }
            
            addNavigationListeners();
            setupPostFilters();
            setupMusicPlayer();
            addMusicEventListeners();
            setupProfileListeners();
            setupAdminPostLogic(is_admin);
            
            updateProfileDisplay(currentUserId, currentUserName, currentUserUsername, is_admin);
            
            loadPostsRealtime(currentUserId);
            
            switchScreen('home-screen');
            if (tg.MainButton) tg.MainButton.hide();
            tg.ready(); 
        }

        function setupTMA() { 
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                const themeParams = tg.themeParams;
                if (themeParams) {
                    const root = document.documentElement;
                    const themeMap = {
                        '--tg-theme-bg-color': themeParams.bg_color || '#0d1117',
                        '--tg-theme-secondary-bg-color': themeParams.secondary_bg_color || '#1a202c',
                        '--tg-theme-text-color': themeParams.text_color || '#ffffff',
                        '--tg-theme-link-color': '#20b2aa', 
                        '--tg-theme-button-color': '#4caf50', 
                        '--tg-theme-button-text-color': themeParams.button_text_color || '#ffffff',
                        '--tg-theme-destructive-text-color': '#ff9800', 
                        '--tg-theme-hint-color': '#bdbdbd'
                    };
                    
                    for (const [prop, value] of Object.entries(themeMap)) {
                        root.style.setProperty(prop, value);
                    }
                    document.body.style.backgroundColor = themeMap['--tg-theme-bg-color'];
                }
                main();
            } else {
                console.warn("Telegram WebApp SDK not found. Running in fallback mode (Local Testing).");
                
                const mockAdminId = ADMIN_CHAT_IDS.length > 0 ? ADMIN_CHAT_IDS[0] : 123456789; 
                tg = {
                    initDataUnsafe: { user: { id: mockAdminId, first_name: "Local", last_name: "Tester", username: "local_tester", photo_url: null } },
                    themeParams: {},
                    ready: () => console.log('TMA Mock Ready'),
                    close: () => console.log('TMA Mock Close'),
                    showConfirm: (msg, callback) => { console.log("Mock Confirm:", msg); callback(true); }, // Mocking showConfirm 
                    HapticFeedback: { impactOccurred: () => console.log('Haptic: Light') },
                    MainButton: { hide: () => console.log('MainButton: Hide') }
                };

                const root = document.documentElement;
                root.style.setProperty('--tg-theme-bg-color', '#0d1117');
                root.style.setProperty('--tg-theme-text-color', '#ffffff');
                root.style.setProperty('--tg-theme-secondary-bg-color', '#1a202c');
                root.style.setProperty('--tg-theme-link-color', '#20b2aa');
                root.style.setProperty('--tg-theme-button-color', '#4caf50');
                root.style.setProperty('--tg-theme-destructive-text-color', '#ff9800');
                root.style.setProperty('--tg-theme-hint-color', '#bdbdbd');
                document.body.style.backgroundColor = 'var(--tg-theme-bg-color)';

                main(); // Call main directly in mock mode since auth is mocked
            }
        }

        // Start Firebase Setup on load
        window.onload = setupFirebase;

    </script>
</body>
</html>

