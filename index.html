<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZZ Feed (Community Posts)</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <!-- CSS File -->
    <link rel="stylesheet" href="tma-style.css">

    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>

    <div class="app-container">
        
        <div class="fixed-header-area">
            <header>
                <div class="music-info-area">
                    <span id="current-music-status">Music Paused (Tap Icon to Play)</span>
                    <i id="volume-toggle" class="fas fa-volume-off" title="Start Playing Music"></i>
                </div>
                <button id="music-button" class="icon-btn" aria-label="Music Settings">
                    <i class="fas fa-cog"></i>
                </button>
            </header>
            
            <div class="filter-tabs" role="tablist">
                <button id="new-posts-tab" class="filter-tab active" data-filter="new-posts" role="tab" aria-selected="true">
                    üî• New Posts
                </button>
                <button class="filter-tab" data-filter="old-posts" role="tab" aria-selected="false">
                    ‚è≥ Oldest
                </button>
            </div>
        </div>

        <div class="content">
            
            <div id="home-screen" class="screen active">
                <div id="posts-container" class="posts-list">
                    <p class="initial-loading-text">Loading posts...</p>
                </div>
            </div>

            <div id="profile-screen" class="screen">
                <div class="profile-card">
                    <div id="profile-avatar-placeholder" class="avatar-placeholder">U</div>
                    <h2 id="profile-display-name">Loading...</h2>
                    <p id="profile-display-username" class="hint-text">Username N/A</p>
                    <span id="admin-status" class="admin-badge">Regular User</span>

                    <div class="info-row">
                        <span>Telegram Chat ID:</span>
                        <div class="copy-area">
                            <span id="telegram-chat-id">0</span>
                            <button id="chat-id-copy-btn" class="icon-btn" aria-label="Copy User ID">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                    </div>

                    <button id="tma-close-btn" class="close-app-btn">
                        <i class="fas fa-times-circle"></i> Close Mini App
                    </button>
                </div>
            </div>
        </div>

        <nav class="bottom-nav">
            <button class="nav-item active" data-screen="home-screen" aria-label="Home Feed">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </button>
            <button class="nav-item" data-screen="profile-screen" aria-label="Profile">
                <i class="fas fa-user"></i>
                <span>Profile</span>
            </button>
        </nav>
        
        <button id="post-add-button" class="fab" aria-label="Add New Post" style="display:none;">
            <i class="fas fa-plus"></i>
        </button>
    </div>

    <!-- Modals -->
    <div id="post-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Create New Post</h3>
            <textarea id="post-input" placeholder="Type your announcement (5-500 chars)" maxlength="500"></textarea>
            <div class="modal-actions">
                <button id="cancel-post-btn" class="modal-cancel-btn">Cancel</button>
                <button id="submit-post-btn" class="modal-submit-btn">Post Now</button>
            </div>
        </div>
    </div>

    <div id="music-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Music Settings</h3>
            <p class="hint-text">Choose your background audio source.</p>
            <div class="music-option-list">
                <button class="music-option" data-music-type="default">
                    <i class="fas fa-headphones"></i> Use Default Lofi
                </button>
                <button class="music-option" data-music-type="url">
                    <i class="fas fa-link"></i> Use Custom URL
                </button>
                <label for="music-upload-input" class="music-option">
                    <i class="fas fa-upload"></i> Upload Local File (.mp3)
                </label>
                <input type="file" id="music-upload-input" accept="audio/mp3,audio/*" style="display: none;">
            </div>
            <div class="modal-actions">
                <button id="cancel-music-modal-btn" class="modal-cancel-btn full-width">Close</button>
            </div>
        </div>
    </div>
    
    <div id="url-input-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>Custom Music URL</h3>
            <input type="url" id="music-url-input" placeholder="Enter HTTP/HTTPS audio link">
            <div class="modal-actions">
                <button id="close-url-modal-btn" class="modal-cancel-btn">Back</button>
                <button id="play-url-btn" class="modal-submit-btn">Set & Play</button>
            </div>
        </div>
    </div>

    <audio id="audio-player" style="display:none;"></audio>

    <div id="custom-toast" class="custom-toast"></div>

    <!-- Firebase Initialization and Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Variables from Canvas Environment (MANDATORY USE)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            try {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app);
                setLogLevel('error'); // Set log level to reduce console noise

                // Globalizing Firebase instances for tma-script.js
                window.app = app;
                window.db = db;
                window.auth = auth;
                window.appId = appId; // Pass app ID globally

                // Authentication using Canvas Token or Anonymous Sign-in
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).then(userCredential => {
                        console.log("Firebase signed in with custom token.", userCredential.user.uid);
                    }).catch(error => {
                        console.error("Custom token sign-in failed:", error);
                        signInAnonymously(auth).then(() => console.log("Signed in anonymously (Fallback)."));
                    });
                } else {
                    // Fallback to anonymous sign-in if no custom token is present
                    signInAnonymously(auth).then(() => console.log("Signed in anonymously."));
                }

                // Start the main application script only after basic Firebase setup
                const script = document.createElement('script');
                script.src = 'tma-script.js';
                document.body.appendChild(script);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('posts-container').innerHTML = '<p class="initial-loading-text" style="color:red;">‚ùå Firebase initialization failed. Check console for details.</p>';
            }
        } else {
            console.error("Firebase config is missing.");
            document.getElementById('posts-container').innerHTML = '<p class="initial-loading-text" style="color:red;">‚ùå Firebase Configuration is missing.</p>';
        }

    </script>
</body>
</html>

